name: Deploy to GitHub Pages

on:
  push:
    branches:
      - "**"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: pages-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2.21.0
        with:
          channel: stable
          flutter-version-file: pubspec.yaml
          cache: true

      - name: Compute deploy paths
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          repo_name="${GITHUB_REPOSITORY##*/}"
          branch_name="${GITHUB_REF_NAME}"
          slug="$(echo "$branch_name" \
            | tr '[:upper:]' '[:lower:]' \
            | sed -E 's#[^a-z0-9._-]+#-#g; s#-+#-#g; s#^-##; s#-$##')"

          if [ -z "$slug" ]; then
            slug="branch"
          fi

          if [ "$branch_name" = "main" ]; then
            destination_dir="."
            base_href="/${repo_name}/"
            deploy_url="https://${GITHUB_REPOSITORY_OWNER}.github.io/${repo_name}/"
          else
            destination_dir="previews/${slug}"
            base_href="/${repo_name}/previews/${slug}/"
            deploy_url="https://${GITHUB_REPOSITORY_OWNER}.github.io/${repo_name}/previews/${slug}/"
          fi

          echo "branch_name=${branch_name}" >> "$GITHUB_OUTPUT"
          echo "slug=${slug}" >> "$GITHUB_OUTPUT"
          echo "destination_dir=${destination_dir}" >> "$GITHUB_OUTPUT"
          echo "base_href=${base_href}" >> "$GITHUB_OUTPUT"
          echo "deploy_url=${deploy_url}" >> "$GITHUB_OUTPUT"

      - name: Get dependencies
        run: flutter pub get

      - name: Build web app with WASM
        run: flutter build web --release --wasm --base-href "${{ steps.vars.outputs.base_href }}"

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: build/web
          destination_dir: ${{ steps.vars.outputs.destination_dir }}
          keep_files: true
          enable_jekyll: false
          full_commit_message: "chore(pages): deploy ${{ steps.vars.outputs.branch_name }} -> ${{ steps.vars.outputs.destination_dir }}"

      - name: Print deployment URL
        run: echo "Deployed to ${{ steps.vars.outputs.deploy_url }}"
