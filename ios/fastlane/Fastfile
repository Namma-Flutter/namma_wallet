default_platform(:ios)

platform :ios do
  # Prevent Fastlane from regenerating README.md on every run
  skip_docs

  # Load environment variables from .env.local
  if File.exist?('.env.local')
    Dotenv.load('.env.local')
  end

  # Shared helpers

  def api_key
    key_path = File.expand_path(ENV["APP_STORE_CONNECT_KEY_PATH"], __dir__)
    app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_filepath: key_path
    )
  end

  def app_identifier
    CredentialsManager::AppfileConfig.try_fetch_value(:app_identifier)
  end

  def pubspec_version_info
    require 'yaml'
    version_string = YAML.load_file("../../pubspec.yaml")['version']
    UI.user_error!("Missing 'version' in pubspec.yaml") if version_string.nil? || version_string.empty?
    parts = version_string.split('+')
    UI.user_error!("pubspec.yaml version '#{version_string}' is missing build number (expected format: x.y.z+n)") unless parts.length == 2
    { version: parts[0], build_number: parts[1] }
  end

  def changelog(version, build_number)
    path = "./metadata/en-US/release_notes.txt"
    File.exist?(path) ? File.read(path) : "Beta build v#{version} (#{build_number})"
  end

  error do |lane, exception|
    UI.error("#{lane} failed: #{exception.message}")
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    info = pubspec_version_info
    version = info[:version]
    build_number = info[:build_number].to_i

    UI.message("Using version from pubspec.yaml: #{version}+#{build_number}")

    # Validate version+build combination (prevent duplicate uploads)
    latest_build = begin
      app_store_build_number(
        api_key: api_key,
        app_identifier: app_identifier,
        live: false,
        version: version
      )
    rescue => e
      UI.message("⚠️  Could not verify existing builds on TestFlight: #{e.message}. Proceeding with build...")
      nil
    end

    if latest_build && latest_build.to_i >= build_number
      UI.user_error!("❌ Version #{version}+#{build_number} already exists on TestFlight (latest build for v#{version}: #{latest_build}). Please increment the build number in pubspec.yaml")
    end

    UI.success("✓ Version validation passed - #{version}+#{build_number} (TestFlight latest for v#{version}: #{latest_build || 'none'})")

    sh("cd ../.. && make release-ipa")

    update_code_signing_settings(use_automatic_signing: true)

    build_app(
      clean: false,
      scheme: "Runner",
      workspace: "Runner.xcworkspace",
      export_method: "app-store",
      skip_build_archive: true,
      archive_path: "../build/ios/archive/Runner.xcarchive",
      xcargs: "-allowProvisioningUpdates"
    )

    testflight(
      api_key: api_key,
      app_identifier: app_identifier,
      changelog: changelog(version, build_number),
    )

    UI.success("Uploaded build #{build_number} (v#{version}) to TestFlight")
  end

  desc "Promote TestFlight to NammaFlutter and External groups"
  lane :'release-candidate' do
    info = pubspec_version_info
    version = info[:version]
    build_number = info[:build_number]

    UI.message("Promoting v#{version} (#{build_number}) to NammaFlutter and External")

    upload_to_testflight(
      api_key: api_key,
      app_identifier: app_identifier,
      app_version: version,
      build_number: build_number,
      groups: ["NammaFlutter", "External"],
      distribute_only: true,
      distribute_external: true,
      notify_external_testers: true
    )

    UI.success("Distributed v#{version} (#{build_number}) to NammaFlutter and External")
  end

  desc "Promote to App Store"
  lane :production do |options|
    info = pubspec_version_info
    version = options[:version] || info[:version]
    build = options[:build] || info[:build_number]

    UI.message("Promoting: v#{version} (#{build})")

    latest_testflight = begin
      app_store_build_number(
        api_key: api_key,
        app_identifier: app_identifier,
        live: false,
        version: version
      )
    rescue => e
      UI.message("⚠️  Could not verify build on TestFlight: #{e.message}. Proceeding...")
      nil
    end

    if latest_testflight && latest_testflight.to_i < build.to_i
      UI.user_error!("Build #{build} not found on TestFlight for v#{version}. Latest is #{latest_testflight}.")
    end

    UI.success("✓ Build #{build} verified on TestFlight")

    deliver(
      api_key: api_key,
      app_version: version,
      build_number: build,
      force: true,
      release_notes: {
        'en-US' => File.read(File.expand_path("./metadata/en-US/release_notes.txt", __dir__)),
        'en-GB' => File.read(File.expand_path("./metadata/en-GB/release_notes.txt", __dir__))
      },
    )

    UI.success("Successfully promoted build #{build} (v#{version}) to App Review")
  end
end
